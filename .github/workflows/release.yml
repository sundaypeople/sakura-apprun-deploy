name: tag-pr
on:
  push:
    branches: ["main"]

jobs:
  tagpr:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
      - id: tagpr
        uses: Songmu/tagpr@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    outputs:
      tag: ${{ steps.tagpr.outputs.tag }}
      pull_request: ${{ steps.tagpr.outputs.pull_request }}

  prepare-release-pr:
    runs-on: ubuntu-latest
    needs: [tagpr]
    permissions:
      contents: write
    if: ${{ needs.tagpr.outputs.pull_request != '' && needs.tagpr.outputs.tag == '' }}
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0
          ref: ${{ fromJSON(needs.tagpr.outputs.pull_request).head.ref }}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: bump version in package.json (from PR title)
        id: setver
        shell: bash
        run: |
          TITLE='${{ fromJSON(needs.tagpr.outputs.pull_request).title }}'
          VER="$(echo "$TITLE" | grep -o 'v[0-9]\+\.[0-9]\+\.[0-9]\+' | tail -1)"
          VER="${VER#v}"

          if [ -z "$VER" ]; then
            echo "Failed to parse version from: $TITLE" >&2
            exit 1
          fi
          jq --arg v "$VER" '.version = $v' package.json > package.json.tmp
          mv package.json.tmp package.json
          echo "version=$VER" >> "$GITHUB_OUTPUT"

      - name: build
        run: |
          npm ci
          npm run build

      - name: commit & push to PR branch
        shell: bash
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json
          git add -f dist/**
          if git diff --cached --quiet; then
            echo "No changes to commit. Skipping."
            exit 0
          fi
          git commit -m "ci(tagpr): set version ${{ steps.setver.outputs.version }} and add built assets"
          git push
